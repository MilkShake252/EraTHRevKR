eratohoReverse0.60 구상システム概要 第0版


0.はじめに
このテ키스トファイルはeratohoReverse0.60の구상システムについて概要を解説することを목적とする。
どちらかというとバリアント側から구상システムを見る説明になっている。
想定される主な読者は、パッチ作者、派生バリアント作者、コードの読めるデバッガの方である。
そのため、구상作者にはわかりにくい点が多々あるかもしれないが、理解して損はないと思う。
また、私の日本語が若干わかりにくいのは仕様である。
内容の正確性については残念ながら保証されない。悪しからず。


----------------------------------------------------------------------------------------------------

1.구상の種類について
구상の呼び出し側から見る구상の種類は以下の通り。
      <구상の種類>          <呼び出しタイミング>
    ・アクション구상        죠교자행동時
    ・조수アクション구상    조수행동時
    ・탈의アクション구상    탈의행동時
    ・이벤트구상          各種이벤트発生時
    ・조수이벤트구상      조수の各種이벤트発生時
    ・각인취득구상          죠교대상の각인취득時
    ・リアクション구상      죠교대상の反応後
    ・미약등사용구상        미약/로션等使用時
구상側から見る구상種類とは必ずしも一致しない。次章にて詳細な比較を行う。

----------------------------------------------------------------------------------------------------

2.구상を呼び出す関数と、実際に呼ばれる구상の関数について
以下に구상の種類と、呼び出しの為の関数、実際に呼ばれる구상の関数の対応を示す。
      <구상の種類>          <呼出関数>          <구상関数>
    ・アクション구상        @KOJO_ACT           @KOJO_ACT_KX1_Y1
    ・조수アクション구상    @KOJO_ACT_ASSI      @KOJO_ACT_ASSI_KX1_Y1
    ・탈의アクション구상    @KOJO_DATUI         @KOJO_DATUI_KX1
                                                @KOJO_DATUI_ASSI_KX1
    ・이벤트구상          @KOJO_EVENT         @KOJO_EVENT_KX1_Y1
    ・조수이벤트구상      @KOJO_EVENT_ASSI    @KOJO_EVENT_ASSI_KX1_Y1
    ・각인취득구상          @KOJO_MARK          @KOJO_MARK_KX1
    ・リアクション구상      @KOJO_REACT         @KOJO_REACT_KX1_Y1
                                                @KOJO_COM_KX1_Y1
    ・미약등사용구상        @KOJO_USE           @KOJO_USE_KX1
呼び出し側は直接구상関数をCALLすることはなく、呼出関数をCALLすることで間接的に구상関数を呼ぶ。
呼出関数はEVENT_K.ERBにて定義される。また、구상関数は各구상ファイルにて定義される。
呼び出し側から意識する필요は無いが、呼出関数から구상関数を呼び出す処理にはもう１クッションある。
대상限定구상では구상関数の名前が異なっており、それを呼び分ける層である。この解説は後程行う。
以下では、各구상毎のより詳しい解説を行う。


2-1.アクション구상
죠교において죠교자행동が行われる際に表示される구상である。
呼び出す際は以下の関数を使用する。
    @KOJO_ACT
この関数から呼ばれる구상関数は
    @KOJO_ACT_KX1_Y1
である。X1には죠교자のキャラ번호、Y1には죠교자행동번호が入る。
戻り値RESULTは、구상を表示했다かどうかを表す値である。
    0…구상を表示しなかったことを表す
    1…구상を表示했다ことを表す
    2…약품使用を含んだアクション구상を表示했다ため、@KOJO_USEを呼ぶ필요が無いことを表す


2-2.조수アクション구상
죠교において조수행동が行われる際に表示される구상である。
呼び出す際は以下の関数を使用する。
    @KOJO_ACT_ASSI
この関数から呼ばれる구상関数は
    @KOJO_ACT_ASSI_KX1_Y1
である。X1には조수のキャラ번호、Y1には조수행동번호が入る。
戻り値RESULTは、구상を表示했다かどうかを表す値である。
    0…구상を表示しなかったことを表す
    1…구상を表示했다ことを表す


2-3.탈의アクション구상
죠교において탈의행동が行われる際に表示される구상である。
呼び出す際は以下の関数を使用する。
    @KOJO_DATUI
この関数から呼ばれる구상関数は
    @KOJO_DATUI_KX1			탈의구상
    @KOJO_DATUI_ASSI_KX1	탈의サポート구상
の２種類存在する。
@KOJO_DATUI_KX1のX1には죠교자のキャラ번호、@KOJO_DATUI_ASSI_KX1のX1には조수のキャラ번호が入る。
통상、죠교자が죠교대상を脱がせた場合は@KOJO_DATUI_KX1(탈의구상)が呼ばれ、
조수が죠교대상を脱がせた場合は@KOJO_DATUI_ASSI_KX1(탈의サポート구상)が呼ばれる。
ただし、조수が<マスター>の場合はこれが反転する。この時、一時的にTARGETとASSIの値が入れ替わる。
そのため、@KOJO_DATUI_KX1関数内では구상主は常にTARGETであり、
@KOJO_DATUI_ASSI_KX1関数内では구상主は常にASSIであることは保証される。
죠교자自身が脱ぐ場合は、@KOJO_DATUI_KX1(탈의구상)が呼ばれる。
ただし、죠교자が죠교대상を脱がせている場合は呼ばれない。
(既に죠교자の탈의구상/탈의サポートを呼んでいるため、再度呼ぶことはしない)
戻り値RESULTは、구상を表示했다かどうかを表す値である。
    0…구상を表示しなかったことを表す
    1…구상を表示했다ことを表す
余談だが、구상側でどちらかの一方の탈의구상を記述했다にも関わらず、
それが表示されなかった場合は<マスター>の存在を疑ってみる필요がある。
例えば구상主が<マスター>だと、@KOJO_DATUI_ASSI_KX1(탈의サポート구상)が呼ばれることは無い。
구상作者もバリアント作者も、この仕様を頭の片隅に入れておいて損はない。


    --変数TEQUIPはキャラ変数？！--
    TEQUIPは本来キャラ変数なので、TEQUIP:MASTER:1のような記述が可能である。
    ただし、eratohoReverseではTEQUIP:1のような記述しか使われていない。
    これはTEQUIP:TARGET:1の省略形であり、MASTERの의상といった本来MASTERが관리すべき情報も
    すべてTARGETにより관리されている。このことは통상あまり問題にならないが、
    탈의アクション구상のように一時的にTARGETの値が変わるようなケースでは、
    TEQUIP:1のような記述は正常な値を参照できなくなってしまう。
    この辺りの処理に손を加える際は、上記の事柄を頭に入れておく필요がある。
    ※eratohoReverseではTARGET-ASSI入れ替えの関数があり、そこで필요な変数を含めた入れ替え処理を行っている


2-4.이벤트구상
各種이벤트の際に表示される구상である。
呼び出す際は以下の関数を使用する。
    @KOJO_EVENT(ARG,ARG:1,ARG:2)
引数の内容は以下の通り。
    ARG  …이벤트번호
    ARG:1…이벤트派生번호。派生が無いものについては、省略してもよい
    ARG:2…구상を呼び出すキャラ등록번호。省略했다場合はTARGET
この関数から呼ばれる구상関数は
    @KOJO_EVENT_KX1_Y1(ARG)
である。X1にはキャラ번호(NO:(ARG:2))、Y1には이벤트번호(ARG)が入る。
また、引数ARGとして이벤트派生번호(ARG:1)が渡される。
戻り値RESULTは、구상を表示했다かどうかを表す値である。
    0…구상を表示しなかったことを表す
    1…구상を表示しており、呼び出し側でDRAWLINEが필요であることを表す
    2…구상を表示しており、呼び出し側で改行が필요であることを表す
    3…구상を表示しており、呼び出し側でDRAWLINEと改行の両方が필요であることを表す


2-5.조수이벤트구상
조수に関する各種이벤트の際に表示される구상である。
呼び出す際は以下の関数を使用する。
    @KOJO_EVENT_ASSI(ARG,ARG:1)
引数の内容は以下の通り。
    ARG  …이벤트번호
    ARG:1…이벤트派生번호。派生が無いものについては、省略してもよい
この関数から呼ばれる구상関数は
    @KOJO_EVENT_ASSI_KX1_Y1(ARG)
である。X1には조수のキャラ번호(NO:ASSI)、Y1には이벤트번호(ARG)が入る。
また、引数ARGとして이벤트派生번호(ARG:1)が渡される。
戻り値RESULTは、구상を表示했다かどうかを表す値である。
    0…구상を表示しなかったことを表す
    1…구상を表示しており、呼び出し側でDRAWLINEが필요であることを表す
    2…구상を表示しており、呼び出し側で改行が필요であることを表す
    3…구상を表示しており、呼び出し側でDRAWLINEと改行の両方が필요であることを表す


2-6.각인취득구상
죠교대상が각인を취득했다際に表示される구상である。
呼び出す際は以下の関数を使用する。
    @KOJO_MARK(ARG,ARG:1,ARG:2,ARG:3,ARG:4)
引数の内容は以下の通り。
    ARG  …취득했다고통각인のレベル。취득していない場合は0
    ARG:1…취득했다쾌락각인のレベル。취득していない場合は0
    ARG:2…취득했다굴복각인のレベル。취득していない場合は0
    ARG:3…취득했다반항각인のレベル。취득していない場合は0
    ARG:4…취득했다트라우마のレベル。취득していない場合は0
この関数から呼ばれる구상関数は
    @KOJO_MARK_KX1(ARG,ARG:1,ARG:2,ARG:3,ARG:4)
である。X1には죠교자のキャラ번호が入る。
また、引数ARG～ARG:4には@KOJO_MARKに渡당했다引数がそのまま渡される。
戻り値RESULTは、구상を表示했다かどうかを表す値である。
    0…구상を表示しなかったことを表す
    1…구상を表示했다ことを表す


2-7.リアクション구상
죠교대상の反応に応じて表示される구상である。
呼び出す際は以下の関数を使用する。
    @KOJO_REACT
この関数から呼ばれる구상関数は
    @KOJO_REACT_KX1_Y1  죠교자행동別に定義される、個別リアクション
    @KOJO_COM_KX1_Y1    죠교대상の反応別に定義される、汎用リアクション
の２種類存在する。
@KOJO_REACT_KX1_Y1のX1には죠교자のキャラ번호、Y1には죠교자행동번호(TFLAG:90)が入る。
@KOJO_COM_KX1_Y1のX1には죠교자のキャラ번호、Y1には죠교대상の反応번호(SELECTCOM)が入る。
この関数はまず、@KOJO_REACT_KX1_Y1の呼び出しを試みる。
これにより구상が表示されなかった場合、@KOJO_COM_KX1_Y1を呼び出す。
戻り値RESULTは、구상を表示했다かどうかを表す値である。
    0…いずれの구상も表示しなかったことを表す
    1…구상を表示했다ことを表す


2-8.미약등사용구상
죠교자により미약や로션等が使われた際に表示される구상である。
(조수がこれらを使用する場合は、조수アクション구상を用いる)
呼び出す際は以下の関数を使用する。
    @KOJO_USE
この関数の呼び出しに際し、アクション구상の呼び出し結果を参照する필요がある。
この関数から呼ばれる구상関数は
    @KOJO_USE_KX1
である。X1には죠교자のキャラ번호が入る。
戻り値RESULTは、구상を表示했다かどうかを表す値である。
    0…いずれの구상も表示しなかったことを表す
    1…구상を表示했다ことを表す

----------------------------------------------------------------------------------------------------

3.대상限定구상の呼び出しと、구상呼び出しの排他処理について
※システムの大まかな動きを理解するだけなら本章を読み飛ばしても構わない
呼出関数から구상関数が呼ばれる際に１クッションあると前述했다が、EVENT_K.ERBの@KOJO_CALLがそれである。
この関数では、대상限定구상の呼び出しや구상呼び出しの排他処理に関する処理を行う。


3-1.대상限定구상の種類
대상限定구상とは、구상の適用範囲として죠교대상(MASTER)を特定条件下に限定するタイプの구상である。
MASTERが条件に当てはまらない場合、その구상は呼ばれない。
限定には以下の種類がある。
        <限定系統>  <限定の種類>    <接頭語>    <呼出条件>
    高  キャラ限定  남자당신    MALEYOU     죠교대상が당신で、素質[남자]がある
                    후타나리당신  TWINYOU     죠교대상が당신で、素質[후타나리]がある
    ↑              페니스付당신  PENISYOU    죠교대상が당신で、素質[남자][후타나리]のいずれかがある
    優              女당신        FEMALEYOU   죠교대상が당신で、素質[남자]がない
    先              指定キャラ限定  NO_KX1      죠교대상が指定のキャラ
    順  性別限定    남자限定      MALE        죠교대상に素質[남자]がある
    位              후타나리限定    TWIN        죠교대상に素質[후타나리]がある
    ↓              페니스付限定    PENIS       죠교대상に素質[남자][후타나리]のいずれかがある
                    女限定          FEMALE      죠교대상に素質[남자]がない
    低  限定なし    통상            (なし)      条件無し
以下は具体的な例である(アクション구상)
    남자당신限定            @KOJO_MALEYOU_ACT_KX1_Y1
    당신限定(指定キャラ限定)  @KOJO_NO0_ACT_KX1_Y1
    女限定                      @KOJO_FEMALE_ACT_KX1_Y1
    限定なし                    @KOJO_ACT_KX1_Y1
なお、X1には죠교자のキャラ번호、Y1には죠교자행동번호が入る。


3-2.関数@KOJO_CALLの概要
@KOJO_CALLは各呼出関数から、実際の구상関数を呼ぶためにCALLされる。
実際の구상関数はここからCALLされる。(厳密にはTRYCALLFORM命令を用いて呼び出しを試みている、というのが正しい)
引数の内容は以下の通り。
    ARGS …呼び出す구상関数名の後半部分
    ARG  …구상主の등록번호。省略당했다場合はTARGET
    ARG:1…呼び出す구상関数の引数の数
    ARG:2…呼び出す구상関数に渡す引数1
    ARG:3…          〃          引数2
    ARG:4…          〃          引数3
    ARG:5…          〃          引数4
    ARG:6…          〃          引数5
現状、구상関数の引数の数は0/1/5のいずれかである。
戻り値RESULTは、구상を表示했다かどうかを表す値である。
    0…いずれの구상も表示しなかったことを表す
    1…구상を表示했다ことを表す


3-3.関数@KOJO_CALLの処理の流れ(概要)
    １．キャラ限定の구상の呼び出しを試みる
    ２．排他処理１(キャラ限定구상と、その他の구상間の不整合を防ぐ)
    ３．性別限定の구상の呼びだしを試みる
    ４．排他処理２(性別限定구상と、통상の구상間の不整合を防ぐ)
    ５．통상の구상(限定なし)の呼び出しを試みる


3-4.排他システムの動き
排他システムとは、구상を共存시켰다場合に不都合な구상補完を防ぐ仕組みである。
あるキャラについて、통상の구상を含め、各種の限定구상を共存시킨다ことが可能である。
その際、限定구상で未定義の구상に関しては통상の구상(あるいは限定の緩い他の限定구상)により補完される。
が、その際に問題になるのが구상間の整合性である。
整合性如何によっては、補完しない方がマシというケースも考えられる。
排他指定당했다場合、系統が異なり우선度が低い구상の呼び出しをスキップする。
系統が同じ場合は排他することは出来ない。
排他を行うかどうかの指定は、구상関数@KOJO_Y1_EXCLUSION_KX1にて行われる。
X1にはキャラ번호、Y1には限定種別ごとの接頭語が入る。
なお、デフォルトでは排他は行っていない。
구상作者は、구상が補完される/補完に用いられるケースがあるということを頭の片隅に入れておくとよい。
(ただし、補完に用いられる前提で구상を書くというのは大変かもしれないので程々に)
限定구상を書こうと考えている구상作者は、このような補完/排他機能もあるということを知っておくと良い。


3-5.まとめ
つまり、こんな感じです。
…──────┬──────────┬─────…
  バリアント  │    구상システム    │구상ファイル
  ﾊﾞﾘｱﾝﾄの関数→呼出関数→@KOJO_CALL→구상関数    
              │                    │            
…──────┴──────────┴─────…
あるいは、こーんな感じ。             ／＼￣￣￣￣￣￣￣￣￣￣￣￣￣￣￣￣￣￣￣
                                   ／    ＼
                                 ／구상関数＼
                               ／            ＼
                             ／@KOJO_DATUI_KX1 ＼
                           ／@KOJO_DATUI_ASSI_KX1＼
                         ／@KOJO_EVENT_ASSI_KX1_Y1 ＼           구상ファイル
                       ／@KOJO_USE_KX1 @KOJO_MARK_KX1＼
                     ／     @KOJO_ACT_ASSI_KX1_Y1      ＼
                   ／@KOJO_COM_KX1_Y1 @KOJO_EVENT_KX1_Y1 ＼
                 ／  @KOJO_ACT_KX1_Y1 @KOJO_REACT_KX1_Y1   ＼
               ／──────────────────────＼────────
             ／                   @KOJO_CALL                   ＼
           ／──────────────────────────＼    구상
         ／                        呼出関数                        ＼  システム
       ／     @KOJO_ACT @KOJO_ACT_ASSI @KOJO_DATUI @KOJO_EVENT       ＼
     ／       @KOJO_EVENT_ASSI @KOJO_MARK @KOJO_REACT @KOJO_USE        ＼
   ／──────────────────────────────────＼──
 ／                               バリアント                               ＼
～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～

----------------------------------------------------------------------------------------------------

4.구상の文字色と表示位置について
※システムの大まかな動きを理解するだけなら本章を読み飛ばしても構わない
구상の文字色は구상関数@KOJO_COLOR_KX1で指定される。
なお、この関数はキャラを通じて単一である。限定구상毎に色が異なると、整合性が取れなくなるためである。
これは各呼出関数から、@KOJO_COLORを通じて呼び出される。
直接呼び出すことは無いので、あまり注意する필요はないだろう。
ただし、各呼出関数にてRESETCOLOR命令が使われていることは意識すべきポイントかもしれない。
구상作者には色指定を行うことをオススメ했다い。デフォルトで使用される구상色は地味な灰色である。
表示位置については、조수の구상は右揃えになるように作られている。
呼び出しに際して注意する点は無いが、バリアント側で地の文などを記述する際は注意が필요かもしれない。
구상作者は、조수구상を書く際に折り返しが発生しないよう気を配る필요があるかもしれない。
右揃えで折り返すと見栄えがよろしくない場合が多く、改行했다方がよい結果を得られるように思う。

----------------------------------------------------------------------------------------------------

5.おわりに
ぱの人へ…もし見ていたら、勝손に変なの書いてごめんなさい。間違っていたらもっとごめんなさい。
もっとReverse系の裾野が広がるといいですね。
そうなれば、相互にノウハウやらパッチやらをやりとり했다り出来るかも。


文責／eratohoReverseのまとめパッチつくったり修正パッチつくったり했다人
      あるいはeraSQスレ7のID:yKFvr4bA


くつ했다、おいしい。 さとりさま、だいすき